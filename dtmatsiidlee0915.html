<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DataMatrix ê²€ì¦ê¸°</title>
<style>
  body {
    background-color: #f0f3f7;
    font-family: Arial, sans-serif;
    margin: 0;
    text-align: center;
  }
  h2 {
    color: #333;
    margin-top: 16px;
  }
  #video {
    width: 90%;
    max-width: 480px;
    border-radius: 12px;
    border: 3px solid #007bff;
    background-color: #000;
  }
  #result-box {
    margin-top: 16px;
    background: white;
    border-radius: 10px;
    padding: 16px;
    display: inline-block;
    text-align: left;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    width: 90%;
    max-width: 480px;
  }
  #result-text {
    font-size: 14px;
    color: #333;
    word-break: break-all;
  }
  #start-btn {
    margin-top: 20px;
    background-color: #007bff;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
  }
  #start-btn:hover {
    background-color: #0056b3;
  }
  .ok { color: #28a745; font-weight: bold; }
  .err { color: #d93025; font-weight: bold; }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 8px;
  }
  th, td {
    border-bottom: 1px solid #ddd;
    padding: 4px;
    text-align: left;
  }
  th { background: #f5f5f5; }
</style>
</head>
<body>

<h2>ğŸ“¦ DataMatrix ì½”ë“œ ê²€ì¦ê¸°</h2>
<video id="video" playsinline autoplay></video>
<br>
<button id="start-btn">ì¹´ë©”ë¼ ì‹¤í–‰</button>

<div id="result-box">
  <h3>ğŸ” ìŠ¤ìº” ê²°ê³¼</h3>
  <div id="result-text">ì•„ì§ ì¸ì‹ëœ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.18.6/umd/index.min.js"></script>

<script>
const video = document.getElementById('video');
const resultText = document.getElementById('result-text');
const startBtn = document.getElementById('start-btn');
let codeReader;

async function startCamera() {
  startBtn.disabled = true;
  startBtn.innerText = "ì¹´ë©”ë¼ ì¤€ë¹„ ì¤‘...";

  try {
    codeReader = new ZXing.BrowserMultiFormatReader();
    const devices = await codeReader.listVideoInputDevices();
    if (devices.length === 0) {
      alert("ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    const backCam = devices.find(d => /back|rear|í›„ë©´/i.test(d.label)) || devices[0];
    await codeReader.decodeFromVideoDevice(backCam.deviceId, video, (result, err) => {
      if (result) handleResult(result.text);
    });

    startBtn.innerText = "ìŠ¤ìº” ì¤‘...";
    startBtn.style.background = "#28a745";
    startBtn.textContent = "ì¹´ë©”ë¼ ì‘ë™ ì¤‘";
  } catch (e) {
    console.error(e);
    alert("ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜: " + e.message);
    startBtn.disabled = false;
    startBtn.innerText = "ì¹´ë©”ë¼ ë‹¤ì‹œ ì‹¤í–‰";
  }
}

function handleResult(data) {
  resultText.innerHTML = `<b>ì¸ì‹ëœ ë°ì´í„°:</b><br>${data.replace(/\r?\n/g, '<br>')}`;
  const parsed = parseDataMatrix(data);
  resultText.innerHTML += parsed.html;
}

function parseDataMatrix(raw) {
  let html = "<hr><b>ì„¸ë¶€ ë¶„ì„ ê²°ê³¼</b><br>";
  const errors = [];

  // ê¸°ë³¸ êµ¬ë¬¸ ì²´í¬
  if (!raw.includes("[)>") || !raw.includes("06") || !raw.includes("")) {
    html += `<div class="err">âŒ ê¸°ë³¸ êµ¬ì¡° ì˜¤ë¥˜ ([)> ...  ëˆ„ë½)</div>`;
    return { html };
  }

  // êµ¬ë¶„ì ë‹¨ìœ„ë¡œ ë‚˜ëˆ„ê¸° ( = ASCII 29)
  const parts = raw.split("").filter(p => p.trim() !== "");

  const data = {
    header: parts[0] || "",
    model: parts.find(p => p.startsWith("V")) || "",
    part: parts.find(p => p.startsWith("P")) || "",
    line: parts.find(p => p.startsWith("S")) || "",
    trace: parts.find(p => p.startsWith("T")) || "",
    maker: parts.find(p => p.startsWith("C")) || "",
  };

  // ë‚ ì§œ ë° ì‹œë¦¬ì–¼ ë¶„ë¦¬
  let datePart = "", serialPart = "";
  if (data.trace && data.trace.length > 8) {
    const t = data.trace.substring(1); // 'T' ì œê±°
    const y = "20" + t.substring(0, 2);
    const m = t.substring(2, 4);
    const d = t.substring(4, 6);
    datePart = `${y}-${m}-${d}`;
    serialPart = t.substring(6);
  }

  // ê²€ì¦ ê·œì¹™
  if (!/V[A-Z0-9]{2,}/.test(data.model)) errors.push("ëª¨ë¸ ì½”ë“œ ì˜¤ë¥˜");
  if (!/^P\d{5,}/.test(data.part)) errors.push("ë¶€í’ˆ ì½”ë“œ í˜•ì‹ ì˜¤ë¥˜");
  if (!/^S[A-Z0-9]+/.test(data.line)) errors.push("ë¼ì¸ ì½”ë“œ í˜•ì‹ ì˜¤ë¥˜");
  if (!/^T\d{6}/.test(data.trace)) errors.push("íŠ¸ë ˆì´ìŠ¤ ì½”ë“œ í˜•ì‹ ì˜¤ë¥˜");
  if (!/^C[A-Z]+/.test(data.maker)) errors.push("ì—…ì²´ ì½”ë“œ í˜•ì‹ ì˜¤ë¥˜");

  const valid = errors.length === 0;

  html += `
  <table>
    <tr><th>í•­ëª©</th><th>ê°’</th></tr>
    <tr><td>ëª¨ë¸</td><td>${data.model}</td></tr>
    <tr><td>ë¶€í’ˆì½”ë“œ</td><td>${data.part}</td></tr>
    <tr><td>ë¼ì¸ì½”ë“œ</td><td>${data.line}</td></tr>
    <tr><td>ë‚ ì§œ</td><td>${datePart}</td></tr>
    <tr><td>ì‹œë¦¬ì–¼</td><td>${serialPart}</td></tr>
    <tr><td>ì—…ì²´</td><td>${data.maker}</td></tr>
  </table>`;

  html += valid
    ? `<div class="ok">âœ… í˜•ì‹ ê²€ì¦ í†µê³¼</div>`
    : `<div class="err">âŒ ì˜¤ë¥˜ í•­ëª©: ${errors.join(", ")}</div>`;

  return { html };
}

startBtn.addEventListener('click', startCamera);
</script>

</body>
</html>
