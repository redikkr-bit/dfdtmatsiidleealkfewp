<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>DATAMATRIX 바코드 스캔</title>

<style>
  body {
      -webkit-touch-callout: none;
      -webkit-text-size-adjust: none;
      -webkit-user-select: none;
      font-size: 12pt;
      margin: 4px;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
  }
  .title {
      font-weight: bold;
      font-size: 16pt;
      line-height: 32px;
      background: #115f97;
      color: white;
      padding: 8px 15px;
      border-radius: 10px 10px 0 0;
      box-shadow: inset 0 0 5px rgba(53,86,129, 0.5);
      text-align: center;
  }
  video {
      width: 100%;
      height: auto;
      flex-grow: 1;
      background: black;
  }
  .memo {
      font-size: 12pt;
      font-weight: bold;
      background-color: #eee;
      color: #000;
      padding: 10px;
      border-radius: 0 0 10px 10px;
      min-height: 40px;
      margin-top: 4px;
      white-space: pre-wrap;
      word-wrap: break-word;
  }
  #resultTable {
      margin-top: 10px;
      overflow-x: auto;
  }
  table { width: 100%; border-collapse: collapse; font-size: 12pt;}
  th, td { border: 1px solid silver; padding: 6px;}
  th { background: #eee;}
  .ct { text-align: center; }
  .rs { color: green; font-weight: bold; }
  .gs { color: red; font-weight: bold; }
  .eot { color: blue; font-weight: bold; }
  .bottomArea {
      padding: 12px 0;
      text-align: center;
      background-color: #115f97;
      border-radius: 0 0 10px 10px;
  }
  button {
      width: 48%;
      height: 50px;
      background-color: #007dc1;
      color: white;
      border-radius: 6px;
      border: none;
      font-weight: bold;
      font-size: 16pt;
      margin: 0 1% 0 1%;
  }
  button:disabled {
      background-color: #666;
  }
</style>

</head>
<body>

<div class="title">DATAMATRIX 바코드 스캔</div>

<video id="video" autoplay muted playsinline></video>
<div id="txtResult" class="memo">스캔 대기 중...</div>

<div id="resultTable" style="display:none;">
    <div class="title">H/KMC부품 2D 바코드 표준</div>
    <table>
        <tbody>
            <tr><th colspan="2">구분</th><th style="width:40px;">결과</th><th>Data</th></tr>
            <tr><th colspan="2">Header</th><td class="ct" id="result00"></td><td id="data00"></td></tr>
            <tr><th rowspan="4" style="width:40px;" id="title_m10">사양<br>정보</th><th>업체코드</th><td class="ct" id="result10"></td><td id="data10"></td></tr>
            <tr><th>부품번호</th><td class="ct" id="result11"></td><td id="data11"></td></tr>
            <tr><th>서열코드</th><td class="ct" id="result12"></td><td id="data12"></td></tr>
            <tr id="tr13"><th>EO번호</th><td class="ct" id="result13"></td><td id="data13"></td></tr>
            <tr><th rowspan="4">추적<br>정보</th><th>생산일자</th><td class="ct" id="result20"></td><td id="data20"></td></tr>
            <tr><th>부품4M</th><td class="ct" id="result21"></td><td id="data21"></td></tr>
            <tr><th>A or @</th><td class="ct" id="result22"></td><td id="data22"></td></tr>
            <tr><th>추적번호(7~)</th><td class="ct" id="result23"></td><td id="data23"></td></tr>
            <tr id="tr30"><th rowspan="2" id="title_m30">부가<br>정보</th><th>특이정보</th><td class="ct" id="result30"></td><td id="data30"></td></tr>
            <tr id="tr31" style="display:none;"><th id="title_m31"></th><th>초도품구분</th><td class="ct" id="result31"></td><td id="data31"></td></tr>
            <tr id="tr40"><th>기타</th><th>업체영역</th><td class="ct" id="result40"></td><td id="data40"></td></tr>
            <tr><th colspan="2">Trailer</th><td class="ct" id="result50"></td><td id="data50"></td></tr>
        </tbody>
    </table>
</div>

<div class="bottomArea">
    <button id="btnStart">스캔 시작</button>
    <button id="btnStop" disabled>스캔 중지</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
  const video = document.getElementById('video');
  const btnStart = document.getElementById('btnStart');
  const btnStop = document.getElementById('btnStop');
  const txtResult = document.getElementById('txtResult');
  const resultTable = document.getElementById('resultTable');

  let stream = null;
  let scanInterval = null;

  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  class DataAnalyzer {
    constructor() {
      this._barcodeData = [];
      this._barcodeDataList = [];
      this._barcodeResultData = [];
      this._barcodeDataStr = "";
      this._barcodeCount = 0;
      this._selectedIndex = 0;
      this._hasEO = false;
      this._hasSpecialInfo = false;
    }

    setBarcodeData(strData) {
      this._barcodeDataStr = strData;
      this._barcodeData = [];
      this._barcodeDataList = [];
      this._barcodeResultData = [];
      this._barcodeCount = 0;
      this._selectedIndex = 0;
      this._hasEO = false;
      this._hasSpecialInfo = false;

      this._strToByteArray(strData);
      this._splitBarcodeSets();
      return this.getCheckResult();
    }
  
    getCheckResult() {
      let result = true;
      this._barcodeResultData = [];

      this._barcodeDataList.forEach((rowData, rowIndex) => {
        const flags = {
          ex_00: false, ex_10: false, ex_11: false, ex_12: false, ex_13: false,
          ex_20: false, ex_21: false, ex_22: false, ex_23: false,
          ex_30: false, ex_31: false, ex_40: false, ex_50: false
        };

        if (rowData.length >= 7 &&
            rowData[0] === 91 && rowData[1] === 41 && rowData[2] === 62 &&
            rowData[3] === 30 && rowData[4] === 48 && rowData[5] === 54 &&
            rowData[6] === 29) {
          flags.ex_00 = true;
          this._addDetail("00", true, rowData.slice(0, 6), rowIndex);
        } else if (rowData[0] === 91) {
          let cutIndex = rowData.findIndex(v => v === 29);
          if (cutIndex > 0) {
            flags.ex_00 = true;
            this._addDetail("00", false, rowData.slice(0, cutIndex), rowIndex);
          }
        } else {
          result = false;
        }

        const len = rowData.length;
        if (len > 0 && (rowData[len - 1] === 35 || rowData[len - 1] === 4)) {
          flags.ex_50 = true;
          if (len >= 4 &&
              rowData[len - 4] === 29 && rowData[len - 3] === 30 &&
              rowData[len - 2] === 4 && rowData[len - 1] === 35) {
            this._addDetail("50", true, rowData.slice(len - 3, len - 1), rowIndex);
          } else if (len >= 3 &&
                     rowData[len - 3] === 29 && rowData[len - 2] === 30 &&
                     rowData[len - 1] === 4) {
            this._addDetail("50", true, rowData.slice(len - 2), rowIndex);
          } else {
            result = false;
            let cutIndex = -1;
            for (let x = len - 1; x >= 0; x--) {
              if (rowData[x] === 29) {
                cutIndex = x + 1;
                break;
              }
            }
            this._addDetail("50", false, rowData.slice(cutIndex), rowIndex);
          }
        }

        this._splitFields(rowData).forEach((partData) => {
          const code = partData[0];
          switch (code) {
            case 86: // V
              flags.ex_10 = true;
              if (partData.length === 5) {
                this._addDetail("10", true, partData.slice(1), rowIndex);
              } else {
                result = false;
                this._addDetail("10", false, partData.slice(1), rowIndex);
              }
              break;
            case 80: // P
              flags.ex_11 = true;
              if (partData.length > 10 && partData.length < 17 && !this._containsCode(partData, 45)) {
                this._addDetail("11", true, partData.slice(1), rowIndex);
              } else {
                result = false;
                this._addDetail("11", false, partData.slice(1), rowIndex);
              }
              break;
            case 83: // S
              flags.ex_12 = true;
              if (partData.length > 0 && partData.length < 10) {
                this._addDetail("12", true, partData.slice(1), rowIndex);
              } else {
                result = false;
                this._addDetail("12", false, partData.slice(1), rowIndex);
              }
              break;
            case 69: // E
              flags.ex_13 = true;
              this._hasEO = true;
              if (partData.length > 8 && partData.length < 11) {
                this._addDetail("13", true, partData.slice(1), rowIndex);
              } else if (partData.length === 1) {
                this._addDetail("13", true, [], rowIndex);
              } else {
                result = false;
                this._addDetail("13", false, partData.slice(1), rowIndex);
              }
              break;
            case 84: // T
              if (partData.length > 6) {
                flags.ex_20 = true;
                if (this._isValidDate(partData.slice(1, 7))) {
                  this._addDetail("20", true, partData.slice(1, 7), rowIndex);
                } else {
                  result = false;
                  this._addDetail("20", false, partData.slice(1, 7), rowIndex);
                }
              }
              if (partData.length > 7) {
                flags.ex_21 = true;
                if (partData.length > 10) {
                  this._addDetail("21", true, partData.slice(7, 11), rowIndex);
                } else {
                  result = false;
                  this._addDetail("21", false, partData.slice(7), rowIndex);
                }
              }
              if (partData.length > 11) {
                flags.ex_22 = true;
                if (partData[11] === 64 || partData[11] === 65) {
                  this._addDetail("22", true, [partData[11]], rowIndex);
                } else {
                  result = false;
                  this._addDetail("22", false, [partData[11]], rowIndex);
                }
              }
              if (partData.length > 12) {
                flags.ex_23 = true;
                if (partData.length > 17 && partData.length < 43) {
                  this._addDetail("23", true, partData.slice(12), rowIndex);
                } else {
                  this._addDetail("23", false, partData.slice(12), rowIndex);
                  result = false;
                }
              }
              break;
            case 68: // D
              flags.ex_20 = true;
              if (this._isValidDate(partData.slice(1, 7))) {
                this._addDetail("20", true, partData.slice(1, 7), rowIndex);
              } else {
                result = false;
                this._addDetail("20", false, partData.slice(1, 7), rowIndex);
              }
              break;
            case 71: // G
              flags.ex_21 = true;
              if (partData.length > 4) {
                this._addDetail("21", true, partData.slice(1, 5), rowIndex);
              } else {
                result = false;
                this._addDetail("21", false, partData.slice(1), rowIndex);
              }
              break;
            case 66: // B
              flags.ex_22 = true;
              if (partData[1] === 64 || partData[1] === 65) {
                this._addDetail("22", true, [partData[1]], rowIndex);
              } else {
                result = false;
                this._addDetail("22", false, [partData[1]], rowIndex);
              }
              break;
            case 72: // H
              flags.ex_23 = true;
              if (partData.length > 7 && partData.length < 32) {
                this._addDetail("23", true, partData.slice(1), rowIndex);
              } else {
                this._addDetail("23", false, partData.slice(1), rowIndex);
                result = false;
              }
              break;
            default:
              if (code >= 49 && code <= 57) {
                flags.ex_30 = true;
                this._hasSpecialInfo = true;
                if (partData.length > 1 && partData.length < 42) {
                  this._addDetail("30", true, partData.slice(2), rowIndex);
                } else {
                  result = false;
                  this._addDetail("30", false, partData.slice(2), rowIndex);
                }
              } else if (code === 77) {
                flags.ex_31 = true;
                if (partData.length === 1) {
                  this._addDetail("31", true, [], rowIndex);
                } else if (partData.length === 2 && (partData[1] === 89 || partData[1] === 78)) {
                  this._addDetail("31", true, [partData[1]], rowIndex);
                } else {
                  result = false;
                  this._addDetail("31", false, partData.length > 1 ? [partData[1]] : null, rowIndex);
                }
              } else if (code === 67) {
                flags.ex_40 = true;
                if (partData.length > 0 && partData.length < 52) {
                  this._addDetail("40", true, partData.slice(1), rowIndex);
                } else {
                  result = false;
                  this._addDetail("40", false, partData.slice(1), rowIndex);
                }
              }
              break;
          }
        });

        if (!flags.ex_00) { result = false; this._addDetail("00", false, this._getFirstBlock(rowData), rowIndex); }
        if (!flags.ex_10) { result = false; this._addDetail("10", false, null, rowIndex); }
        if (!flags.ex_11) { result = false; this._addDetail("11", false, null, rowIndex); }
        if (!flags.ex_12) { this._addDetail("12", true, null, rowIndex); }
        if (!flags.ex_20) { result = false; this._addDetail("20", false, null, rowIndex); }
        if (!flags.ex_21) { result = false; this._addDetail("21", false, null, rowIndex); }
        if (!flags.ex_22) { result = false; this._addDetail("22", false, null, rowIndex); }
        if (!flags.ex_23) { result = false; this._addDetail("23", false, null, rowIndex); }
        if (!flags.ex_50) { result = false; this._addDetail("50", false, this._getLastBlock(rowData), rowIndex); }
      });

      return result;
    }
  
    getResultData() {
      return this._barcodeResultData;
    }
    
    isEOAvailable() {
      return this._hasEO;
    }
    
    isSpecialInfoAvailable() {
      return this._hasSpecialInfo;
    }
  
    _strToByteArray(str) {
      this._barcodeData = [];
      for (let i = 0; i < str.length; i++) {
        this._barcodeData.push(str.charCodeAt(i));
      }
    }
  
    _splitBarcodeSets() {
      this._barcodeDataList = [];
      let rowData = [];
      this._barcodeCount = 0;
      for (let v of this._barcodeData) {
        rowData.push(v);
        if (v === 35) {
          this._barcodeDataList.push(rowData);
          rowData = [];
          this._barcodeCount++;
        }
      }
      if (rowData.length > 0) {
        this._barcodeDataList.push(rowData);
        this._barcodeCount++;
      }
    }
  
    _addDetail(type, okng, dispData, rowIndex) {
      if (this._selectedIndex === rowIndex) {
        let strOKNG = "";
        if (type !== "00" && type !== "50" && type !== "40") {
          if (this._hasBadASCII(dispData)) okng = false;
        }
        strOKNG = okng ? "<span class='eot'>OK</span>" : "<span class='gs'>NG</span>";
        this._barcodeResultData.push([type, strOKNG, dispData ? this._toDisplayString(dispData) : null]);
      }
    }
  
    _splitFields(arrData) {
      const fields = [];
      let current = [];
      for (let v of arrData) {
        if (v === 29) {
          fields.push(current);
          current = [];
        } else if (v !== 32) {
          current.push(v);
        }
      }
      if (current.length) fields.push(current);
      return fields;
    }
  
    _containsCode(arrData, code) {
      return arrData.some(v => v === code);
    }
  
    _isValidDate(arr) {
      if (!arr || arr.length < 6) return false;
      let strDate = "";
      arr.forEach(c => strDate += String.fromCharCode(c));
      if (!/^[0-9]{6}$/.test(strDate)) return false;
      const y = 2000 + parseInt(strDate.substr(0, 2), 10);
      const m = parseInt(strDate.substr(2, 2), 10);
      const d = parseInt(strDate.substr(4, 2), 10);
      if (m < 1 || m > 12 || d < 1) return false;
      const mdays = [31, ((y % 4 === 0 && y % 100 !== 0) || (y % 400 === 0)) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
      return d <= mdays[m - 1];
    }
  
    _getFirstBlock(arrData) {
      const cutIndex = arrData.findIndex(v => v === 29);
      return cutIndex >= 0 ? arrData.slice(0, cutIndex) : arrData;
    }
  
    _getLastBlock(arrData) {
      for (let i = arrData.length - 1; i >= 0; i--) {
        if (arrData[i] === 29) return arrData.slice(i + 1);
      }
      return [];
    }
  
    _hasBadASCII(arrData) {
      if (!arrData || arrData.length === 0) return false;
      if (arrData.length === 1) {
        const v = arrData[0];
        return v < 47 || (v > 57 && v < 65) || (v > 90 && v < 97) || (v > 122);
      }
      return arrData.some(v => v < 47 || (v > 57 && v < 65) || (v > 90 && v < 97) || (v > 122));
    }
  
    _toDisplayString(arrData) {
      if (typeof arrData === "number") return this._charForCode(arrData);
      return arrData.map(c => this._charForCode(c)).join("");
    }
  
    _charForCode(c) {
      switch (c) {
        case 29: return "<sup>G</sup><sub>S</sub>";
        case 30: return "<sup>R</sup><sub>S</sub>";
        case 4: return "<sup>E</sup>O<sub>T</sub>";
        case 35: return "#\n";
        case 34: return "\"";
        case 39: return "\"";
        case 96: return "`";
        default:
          if (c >= 0 && c <= 32 || c === 127) return `<0x${c.toString(16).toUpperCase().padStart(2,"0")}>`;
          return String.fromCharCode(c);
      }
    }
  }

  const analyzer = new DataAnalyzer();

  function drawLine(begin, end, color) {
    ctx.beginPath();
    ctx.moveTo(begin.x, begin.y);
    ctx.lineTo(end.x, end.y);
    ctx.lineWidth = 4;
    ctx.strokeStyle = color;
    ctx.stroke();
  }

  async function startCamera() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      txtResult.textContent = "카메라 접근이 지원되지 않는 브라우저입니다.";
      return;
    }
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      video.srcObject = stream;
      await video.play();

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      txtResult.textContent = "카메라가 켜졌습니다. 바코드를 비추세요.";
      scanInterval = setInterval(scanBarcode, 500);

      btnStart.disabled = true;
      btnStop.disabled = false;
    } catch (e) {
      txtResult.textContent = "카메라 권한 요청 실패: " + e.message;
    }
  }

  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      stream = null;
    }
    if(scanInterval) {
      clearInterval(scanInterval);
      scanInterval = null;
    }
    video.pause();
    video.srcObject = null;
    txtResult.textContent = "스캔 중지됨";
    resultTable.style.display = "none";

    btnStart.disabled = false;
    btnStop.disabled = true;
  }

  function scanBarcode() {
    if (video.readyState !== video.HAVE_ENOUGH_DATA) return;
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

    const code = jsQR(imageData.data, imageData.width, imageData.height, {
      inversionAttempts: "attemptBoth",
    });

    if (code) {
      drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FF3B58");
      drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FF3B58");
      drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF3B58");
      drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF3B58");

      processScannedCode(code.data);
    }
  }

  function processScannedCode(data) {
    txtResult.textContent = "스캔 데이터: " + data;
    const verified = analyzer.setBarcodeData(data);

    if (verified) {
      txtResult.textContent = "스캔 데이터: " + data + " (검증 성공)";
      showResultTable(analyzer.getResultData());
    } else {
      txtResult.textContent = "스캔 데이터: " + data + " (검증 실패)";
      resultTable.style.display = "none";
    }
  }

  function showResultTable(results) {
    resultTable.style.display = "block";

    const eoRow = document.getElementById("tr13");
    const specialRow = document.getElementById("tr30");

    results.forEach(item => {
      const resultCell = document.getElementById("result" + item[0]);
      const dataCell = document.getElementById("data" + item[0]);
      if (resultCell) resultCell.innerHTML = item[1] === "N/A" ? "" : item[1];
      if (dataCell) dataCell.textContent = item[2] || "";
    });

    eoRow.style.display = analyzer.isEOAvailable() ? "" : "none";
    specialRow.style.display = analyzer.isSpecialInfoAvailable() ? "" : "none";
  }

  btnStart.addEventListener('click', startCamera);
  btnStop.addEventListener('click', stopCamera);

</script>
</body>
</html>
