<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DataMatrix ê²€ì¦ê¸°</title>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.18.6/umd/index.min.js"></script>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    text-align: center;
    margin: 0;
    padding: 0;
    background: #f7f7f7;
  }
  h2 {
    background: #004aad;
    color: white;
    padding: 10px;
    margin: 0;
  }
  video {
    width: 90%;
    max-width: 500px;
    margin-top: 10px;
    border-radius: 10px;
    border: 3px solid #004aad;
  }
  #result {
    margin-top: 20px;
    font-size: 1rem;
    white-space: pre-wrap;
    text-align: left;
    display: inline-block;
    background: white;
    border-radius: 8px;
    padding: 10px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
  }
  .ok { color: green; font-weight: bold; }
  .ng { color: red; font-weight: bold; }
</style>
</head>

<body>
<h2>ğŸ“¦ DataMatrix ì½”ë“œ ê²€ì¦ê¸°</h2>
<video id="video" autoplay muted playsinline></video>
<div id="result">ì¹´ë©”ë¼ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. ì½”ë“œë¥¼ ë¹„ì¶°ì£¼ì„¸ìš”.</div>

<script>
const resultBox = document.getElementById('result');
const codeReader = new ZXing.BrowserMultiFormatReader();

async function startScanner() {
  try {
    const devices = await codeReader.listVideoInputDevices();
    // í›„ë©´ ì¹´ë©”ë¼ ìš°ì„  ì„ íƒ
    const backCam = devices.find(d => /back|rear|í›„ë©´|í™˜ê²½/i.test(d.label)) || devices[0];

    await codeReader.decodeFromVideoDevice(backCam.deviceId, 'video', (result, err) => {
      if (result) {
        handleCode(result.text);
      }
    });
  } catch (err) {
    console.error(err);
    resultBox.textContent = 'âŒ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: ' + err;
  }
}

// ------------------------------
// ğŸ“ ê²€ì¦ ê·œì¹™ (ì°¸ê³ : ì—…ë¡œë“œëœ ìŠ¤í¬ë¦°ìƒ· ê¸°ë°˜)
// ------------------------------
function validateCode(text) {
  const rules = [];

  // ANSI MH10.8.2 í˜•íƒœ íŒŒì•… ì—¬ë¶€
  const hasHeader = text.startsWith("[)>");
  const hasTrailer = text.includes("");
  if (hasHeader && hasTrailer) {
    rules.push({ name: "í˜•ì‹ ì‹ë³„", ok: true, value: "ISO15434 êµ¬ì¡° ê°ì§€ë¨" });
  } else {
    rules.push({ name: "í˜•ì‹ ì‹ë³„", ok: false, value: "ISO15434 í˜•ì‹ ì•„ë‹˜" });
  }

  // T(ë‚ ì§œ) í•„ë“œ í™•ì¸
  const tMatch = text.match(/T(\d{6,8})/);
  if (tMatch) {
    rules.push({ name: "ë‚ ì§œ ì½”ë“œ(T)", ok: true, value: tMatch[1] });
  } else {
    rules.push({ name: "ë‚ ì§œ ì½”ë“œ(T)", ok: false, value: "ëˆ„ë½ë¨" });
  }

  // DWA, DRM ë“± ì‹œë¦¬ì–¼ ì½”ë“œ í™•ì¸
  const serialMatch = text.match(/DWA\d+|DRM\d+|A\d{5,}/);
  if (serialMatch) {
    rules.push({ name: "ì‹œë¦¬ì–¼ì½”ë“œ", ok: true, value: serialMatch[0] });
  } else {
    rules.push({ name: "ì‹œë¦¬ì–¼ì½”ë“œ", ok: false, value: "ì—†ìŒ" });
  }

  // P(í’ˆë²ˆ) í•„ë“œ í™•ì¸
  const pMatch = text.match(/P\d{5,}/g);
  if (pMatch) {
    rules.push({ name: "í’ˆë²ˆ(P)", ok: true, value: pMatch.join(', ') });
  } else {
    rules.push({ name: "í’ˆë²ˆ(P)", ok: false, value: "ì—†ìŒ" });
  }

  // S(ì„œì—´ì½”ë“œ)
  const sMatch = text.match(/S[A-Z0-9]+/);
  if (sMatch) {
    rules.push({ name: "ì„œì—´ì½”ë“œ(S)", ok: true, value: sMatch[0] });
  } else {
    rules.push({ name: "ì„œì—´ì½”ë“œ(S)", ok: false, value: "ì—†ìŒ" });
  }

  return rules;
}

// ------------------------------
// ê²°ê³¼ í‘œì‹œ
// ------------------------------
function handleCode(text) {
  const rules = validateCode(text);
  let html = `<div style="font-size:0.9rem;"><b>ì¸ì‹ëœ ì½”ë“œ:</b><br>${text}</div><hr>`;
  rules.forEach(r => {
    html += `<div>${r.ok ? "âœ…" : "âŒ"} <b>${r.name}</b> â†’ <span class="${r.ok ? 'ok' : 'ng'}">${r.value}</span></div>`;
  });
  resultBox.innerHTML = html;
}

// ì‹¤í–‰
startScanner();
</script>
</body>
</html>
