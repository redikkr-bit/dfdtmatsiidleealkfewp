<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DataMatrix 코드 검증기</title>
<style>
  body {
    margin: 0;
    font-family: 'Arial', sans-serif;
    background: #eef2f7;
    text-align: center;
    color: #333;
  }

  header {
    background: #1d3557;
    color: white;
    padding: 14px 0;
    font-size: 18px;
    font-weight: bold;
    letter-spacing: 0.5px;
  }

  #camera-box {
    background: black;
    width: 100%;
    max-width: 500px;
    margin: 10px auto;
    border-radius: 10px;
    overflow: hidden;
    position: relative;
  }

  video {
    width: 100%;
    height: auto;
    object-fit: cover;
  }

  #start-btn {
    margin-top: 10px;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    background: #457b9d;
    color: white;
    font-size: 16px;
    cursor: pointer;
  }

  #start-btn:disabled {
    background: gray;
    cursor: not-allowed;
  }

  #result-panel {
    background: white;
    border-radius: 12px;
    margin: 16px auto;
    padding: 16px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.15);
    text-align: left;
  }

  .field {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
  }

  .label {
    font-weight: bold;
    color: #1d3557;
  }

  .value {
    color: #111;
    font-weight: 500;
  }

  .status-ok {
    color: #2a9d8f;
    font-weight: bold;
    font-size: 15px;
    text-align: center;
    margin-top: 10px;
  }

  .status-err {
    color: #e63946;
    font-weight: bold;
    font-size: 15px;
    text-align: center;
    margin-top: 10px;
  }

  footer {
    margin: 10px;
    font-size: 12px;
    color: #777;
  }
</style>
</head>
<body>

<header>📦 DataMatrix 코드 검증기</header>

<div id="camera-box">
  <video id="video" playsinline autoplay></video>
</div>

<button id="start-btn">카메라 실행</button>

<div id="result-panel">
  <div class="field"><div class="label">모델</div><div class="value" id="model-val">-</div></div>
  <div class="field"><div class="label">부품코드</div><div class="value" id="part-val">-</div></div>
  <div class="field"><div class="label">라인코드</div><div class="value" id="line-val">-</div></div>
  <div class="field"><div class="label">생산일자</div><div class="value" id="date-val">-</div></div>
  <div class="field"><div class="label">시리얼</div><div class="value" id="serial-val">-</div></div>
  <div class="field"><div class="label">업체</div><div class="value" id="maker-val">-</div></div>

  <div id="status-text" class="status-err">인식 대기 중...</div>
</div>

<footer>ver. Web Scanner UI - iOS Safari 최적화</footer>

<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.18.6/umd/index.min.js"></script>

<script>
const startBtn = document.getElementById('start-btn');
const video = document.getElementById('video');
const statusText = document.getElementById('status-text');

const fModel = document.getElementById('model-val');
const fPart = document.getElementById('part-val');
const fLine = document.getElementById('line-val');
const fDate = document.getElementById('date-val');
const fSerial = document.getElementById('serial-val');
const fMaker = document.getElementById('maker-val');

let codeReader;

async function startCamera() {
  startBtn.disabled = true;
  startBtn.innerText = "카메라 실행 중...";

  try {
    codeReader = new ZXing.BrowserMultiFormatReader();
    const devices = await codeReader.listVideoInputDevices();
    if (devices.length === 0) {
      alert("카메라를 찾을 수 없습니다.");
      return;
    }

    const backCam = devices.find(d => /back|rear|후면/i.test(d.label)) || devices[0];
    await codeReader.decodeFromVideoDevice(backCam.deviceId, video, (result, err) => {
      if (result) parseCode(result.text);
    });

    statusText.textContent = "카메라 작동 중...";
    statusText.className = "status-ok";
    startBtn.innerText = "스캔 중...";
  } catch (e) {
    console.error(e);
    alert("카메라 접근 오류: " + e.message);
    startBtn.disabled = false;
    startBtn.innerText = "카메라 다시 실행";
  }
}

function parseCode(raw) {
  if (!raw.includes("[)>") || !raw.includes("06") || !raw.includes("")) {
    statusText.textContent = "❌ 코드 구조 오류";
    statusText.className = "status-err";
    return;
  }

  const parts = raw.split("").filter(p => p.trim() !== "");

  const data = {
    model: parts.find(p => p.startsWith("V")) || "",
    part: parts.find(p => p.startsWith("P")) || "",
    line: parts.find(p => p.startsWith("S")) || "",
    trace: parts.find(p => p.startsWith("T")) || "",
    maker: parts.find(p => p.startsWith("C")) || "",
  };

  let datePart = "", serialPart = "";
  if (data.trace && data.trace.length > 8) {
    const t = data.trace.substring(1);
    const y = "20" + t.substring(0, 2);
    const m = t.substring(2, 4);
    const d = t.substring(4, 6);
    datePart = `${y}-${m}-${d}`;
    serialPart = t.substring(6);
  }

  fModel.textContent = data.model || "-";
  fPart.textContent = data.part || "-";
  fLine.textContent = data.line || "-";
  fDate.textContent = datePart || "-";
  fSerial.textContent = serialPart || "-";
  fMaker.textContent = data.maker || "-";

  // 검증 로직
  const errors = [];
  if (!/V[A-Z0-9]{2,}/.test(data.model)) errors.push("모델");
  if (!/^P\d{5,}/.test(data.part)) errors.push("부품");
  if (!/^S[A-Z0-9]+/.test(data.line)) errors.push("라인");
  if (!/^T\d{6}/.test(data.trace)) errors.push("트레이스");
  if (!/^C[A-Z]+/.test(data.maker)) errors.push("업체");

  if (errors.length === 0) {
    statusText.textContent = "✅ 검증 완료 (정상)";
    statusText.className = "status-ok";
  } else {
    statusText.textContent = `❌ 오류: ${errors.join(", ")}`;
    statusText.className = "status-err";
  }
}

startBtn.addEventListener('click', startCamera);
</script>

</body>
</html>
