<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>DataMatrix 검증기</title>
<style>
  * {
    -webkit-tap-highlight-color: rgba(255, 255, 255, 0) !important;
    -webkit-focus-ring-color: rgba(255, 255, 255, 0) !important;
    outline: none !important;
  }
  body {
    -webkit-touch-callout: none;
    -webkit-text-size-adjust: none;
    -webkit-user-select: none;
    font-size:12pt;
    height:100%;
    margin:4px 4px 98px 4px;
    padding:0px;
    background:#f2f6fb;
    color:#222;
    font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial;
  }
  header {
    background:#1565c0;
    color:#fff;
    padding:12px 14px;
    font-size:18px;
    font-weight:600;
  }
  .container {
    padding:12px;
  }
  .video-wrap {
    background:#000;
    border-radius:8px;
    overflow:hidden;
    max-width:720px;
    position:relative;
    min-height:300px;
  }
  video {
    width:100%;
    height:auto;
    display:block;
  }
  .scan-overlay {
    position:absolute;
    top:0;
    left:0;
    right:0;
    bottom:0;
    display:flex;
    justify-content:center;
    align-items:center;
    pointer-events:none;
  }
  .scan-frame {
    width:70%;
    height:70%;
    border:2px solid #00ff00;
    border-radius:8px;
    box-shadow:0 0 0 1000px rgba(0,0,0,0.5);
  }
  .status {
    text-align:center;
    color:#fff;
    margin-top:10px;
    font-weight:bold;
  }
  .bottomArea {
    position:fixed;
    bottom:0px;
    left:0px;
    right:0px;
    padding:12px 0px;
    text-align:center;
    background-image:linear-gradient(to bottom, #f5f5f5, #e5e5e5);
    border-top:solid 4px #24A7D3;
  }
  .bottomArea button {
    width:48%;
    height:60px;
    margin:0 1%;
  }
  button {
    -moz-box-shadow:inset 0px 1px 0px 0px #54a3f7;
    -webkit-box-shadow:inset 0px 1px 0px 0px #54a3f7;
    box-shadow:inset 0px 1px 0px 0px #54a3f7;
    background:linear-gradient(to bottom, #007dc1 5%, #0061a7 100%);
    filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#007dc1', endColorstr='#0061a7',GradientType=0);
    background-color:#007dc1;
    border-radius:6px;
    border:1px solid #124d77;
    display:inline-block;
    cursor:pointer;
    color:#ffffff;
    padding:0px;
    font-size:14pt;
    font-weight:bold;
    text-shadow:0px 1px 0px #154682;
  }
  button:active {
    transform:scale(.95);
  }
  button:disabled {
    background:#ccc;
    cursor:not-allowed;
  }
  .title {
    margin: 0.2em 0 0 0;
    font-weight: bold;
    position: relative;
    text-shadow: 0 -1px rgba(0,0,0,0.6);
    font-size: 14pt;
    line-height: 32px;
    background: #115f97;
    padding: 5px 15px;
    color: white;
    border-radius: 10px 10px 0 0;
    box-shadow: inset 0 0 5px rgba(53,86,129, 0.5);
  }
  .memo {
    font-size:12pt;
    font-weight:bold;
    border:solid 1px silver;
    background-color:#eee;
    padding:10px;
    word-break:normal;
    word-wrap:break-word;
    white-space:pre-line;
    overflow:hidden;
    min-height:40px;
    margin-bottom:10px;
    border-radius: 0 0 10px 10px;
  }
  table {
    width:100%;
    border-collapse:collapse;
  }
  th {
    background-color:#eee;
    padding:8px;
  }
  table, td, th {
    border:solid 1px silver;
  }
  td {
    word-break:break-all;
    white-space:pre-line;
  }
  .ct {
    text-align:center;
  }
  .gs{color:red;font-weight:bold;}
  .rs{color:green;font-weight:bold;}
  .eot{color:blue;font-weight:bold;}
  .ok{color:#0b7b0b;font-weight:700;}
  .ng{color:#c62828;font-weight:700;}
  .gray {color:silver;font-weight:bold;}
  .hint {
    font-size:13px;
    color:#666;
    margin-top:8px;
  }
  input[type=file] {
    display:none;
  }
  .file-label {
    background:#ddd;
    color:#333;
    border:none;
    padding:10px 12px;
    border-radius:8px;
    font-weight:600;
    cursor:pointer;
    display:inline-block;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest/umd/index.min.js"></script>
</head>
<body>
<header>DataMatrix 검증기</header>
<div class="container">
  <div class="video-wrap" id="videoWrap">
    <video id="video" playsinline></video>
    <div class="scan-overlay">
      <div class="scan-frame"></div>
      <div class="status" id="status">카메라 시작 버튼을 누르세요</div>
    </div>
  </div>

  <div class="bottomArea">
    <button id="startBtn">카메라 시작</button>
    <button id="stopBtn" disabled>카메라 중지</button>
    <label class="file-label">
      이미지 업로드
      <input id="fileInput" type="file" accept="image/*" />
    </label>
  </div>

  <div class="result" id="resultBox">
    <div class="title">바코드내용</div>
    <div class="memo" id="rawText">(스캔 또는 업로드 후 결과가 여기에 표시됩니다)</div>

    <div class="title">H/KMC부품 2D 바코드 표준</div>
    <table>
      <tr>
        <th colspan=2>구분</th>
        <th style="width:40px;">결과</th>
        <th>Data</th>
      </tr>
      <tr>
        <th colspan=2>Header</th>
        <td class="ct" id="result00"></td>
        <td id="data00"></td>
      </tr>
      <tr>
        <th rowspan=4 style="width:40px;">사양<br>정보</th>
        <th style="width:80px;">업체코드</th>
        <td class="ct" id="result10"></td>
        <td id="data10"></td>
      </tr>
      <tr>
        <th>부품번호</th>
        <td class="ct" id="result11"></td>
        <td id="data11"></td>
      </tr>
      <tr>
        <th>서열코드</th>
        <td class="ct" id="result12"></td>
        <td id="data12"></td>
      </tr>
      <tr id="tr13">
        <th>EO번호</th>
        <td class="ct" id="result13"></td>
        <td id="data13"></td>
      </tr>
      <tr>
        <th rowspan=4>추적<br>정보</th>
        <th>생산일자</th>
        <td class="ct" id="result20"></td>
        <td id="data20"></td>
      </tr>
      <tr>
        <th>부품4M</th>
        <td class="ct" id="result21"></td>
        <td id="data21"></td>
      </tr>
      <tr>
        <th>A or @</th>
        <td class="ct" id="result22"></td>
        <td id="data22"></td>
      </tr>
      <tr>
        <th>추적번호(7~)</th>
        <td class="ct" id="result23"></td>
        <td id="data23"></td>
      </tr>
      <tr id="tr30">
        <th rowspan=2>부가<br>정보</th>
        <th>특이정보</th>
        <td class="ct" id="result30"></td>
        <td id="data30"></td>
      </tr>
      <tr id="tr31">
        <th>초도품구분</th>
        <td class="ct" id="result31"></td>
        <td id="data31"></td>
      </tr>
      <tr id="tr40">
        <th>기타</th>
        <th>업체영역</th>
        <td class="ct" id="result40"></td>
        <td id="data40"></td>
      </tr>
      <tr>
        <th colspan=2>Trailer</th>
        <td class="ct" id="result50"></td>
        <td id="data50"></td>
      </tr>
    </table>

    <div class="hint">참고: ANSI / ISO 15434 스타일의 구분자( RS=ASCII30, GS=ASCII29, EOT=ASCII4 )와 일반문자 '#', 'EOT' 등 여러 표현을 허용하여 인식합니다.</div>
  </div>
</div>

<script>
// DataMatrix 검증기 - 최종 버전
(function(){
  const video = document.getElementById('video');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const fileInput = document.getElementById('fileInput');
  const rawText = document.getElementById('rawText');
  const statusEl = document.getElementById('status');
  
  const codeReader = new ZXing.BrowserMultiFormatReader();
  let isScanning = false;
  let currentDeviceId = null;

  // 상태 업데이트
  function updateStatus(message) {
    statusEl.textContent = message;
  }

  // 결과 표시 업데이트
  function setResult(id, ok, val) {
    const resultEl = document.getElementById('result' + id);
    const dataEl = document.getElementById('data' + id);
    
    if (ok === null) {
      resultEl.innerHTML = '';
      dataEl.textContent = '';
      return;
    }
    
    resultEl.innerHTML = ok ? '<span class="ok">OK</span>' : '<span class="ng">NG</span>';
    dataEl.textContent = val || '';
  }

  // 모든 결과 초기화
  function clearResults() {
    ['00','10','11','12','13','20','21','22','23','30','31','40','50'].forEach(id => {
      setResult(id, null, '');
    });
  }

  // 카메라 시작
  startBtn.addEventListener('click', async () => {
    if (isScanning) return;
    
    try {
      updateStatus('카메라 접근 중...');
      startBtn.disabled = true;
      
      // 사용 가능한 카메라 장치 목록 가져오기
      const videoInputDevices = await codeReader.listVideoInputDevices();
      
      if (videoInputDevices.length === 0) {
        updateStatus('카메라를 찾을 수 없습니다');
        startBtn.disabled = false;
        return;
      }
      
      // 후면 카메라 우선 선택
      let selectedDeviceId = videoInputDevices[0].deviceId;
      const backCamera = videoInputDevices.find(device => 
        device.label.toLowerCase().includes('back') || 
        device.label.toLowerCase().includes('rear') ||
        device.label.toLowerCase().includes('후면')
      );
      
      if (backCamera) {
        selectedDeviceId = backCamera.deviceId;
      }
      
      currentDeviceId = selectedDeviceId;
      
      // 비디오 요소 설정
      video.setAttribute('autoplay', '');
      video.setAttribute('muted', '');
      video.setAttribute('playsinline', '');
      
      // 지속적인 디코딩 시작
      codeReader.decodeFromVideoDevice(selectedDeviceId, video, (result, err) => {
        if (result) {
          updateStatus('코드 인식 성공!');
          parseAndValidate(result.text);
          
          setTimeout(() => {
            if (isScanning) {
              updateStatus('코드를 스캔 중...');
            }
          }, 1500);
        }
        
        if (err && !(err instanceof ZXing.NotFoundException)) {
          console.error('Decode error:', err);
        }
      });
      
      updateStatus('코드를 스캔 중...');
      stopBtn.disabled = false;
      isScanning = true;
      
    } catch (error) {
      console.error('Camera error:', error);
      updateStatus('카메라 접근 실패: ' + error.message);
      startBtn.disabled = false;
    }
  });

  // 카메라 중지
  stopBtn.addEventListener('click', () => {
    stopScanning();
    updateStatus('카메라가 중지되었습니다');
  });

  function stopScanning() {
    if (isScanning) {
      codeReader.reset();
      isScanning = false;
    }
    
    if (video.srcObject) {
      video.srcObject.getTracks().forEach(track => track.stop());
      video.srcObject = null;
    }
    
    startBtn.disabled = false;
    stopBtn.disabled = true;
    currentDeviceId = null;
  }

  // 파일 업로드 처리
  fileInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = async (e) => {
      updateStatus('이미지 분석 중...');
      
      try {
        const result = await codeReader.decodeFromImage(undefined, e.target.result);
        if (result) {
          parseAndValidate(result.text);
          updateStatus('이미지에서 코드 인식 성공!');
        } else {
          updateStatus('이미지에서 코드를 찾을 수 없습니다');
        }
      } catch (error) {
        updateStatus('이미지 디코딩 실패: ' + error.message);
      }
    };
    reader.readAsDataURL(file);
  });

  // DataMatrix 파싱 및 검증 함수
  function parseAndValidate(raw) {
    if (!raw) return;
    
    // 원본 데이터 표시 (특수 문자 시각화)
    const displayText = raw
      .replace(/\x1D/g, '<span class="gs">ᴳS</span>')
      .replace(/\x1E/g, '<span class="rs">ᴿS</span>')
      .replace(/\x04/g, '<span class="eot">EOT</span>')
      .replace(/#/g, '#<br>');
    
    rawText.innerHTML = displayText;
    
    // 검증 결과 초기화
    clearResults();
    
    // DataAnalyzer.js 규칙에 따른 검증 수행
    const validationResult = validateDataMatrix(raw);
    
    // 검증 결과 표시
    Object.keys(validationResult).forEach(key => {
      const result = validationResult[key];
      setResult(key, result.ok, result.value);
    });
  }

  // DataAnalyzer.js 검증 규칙 구현
  function validateDataMatrix(raw) {
    const result = {
      '00': { ok: false, value: '' }, // Header
      '10': { ok: false, value: '' }, // 업체코드
      '11': { ok: false, value: '' }, // 부품번호
      '12': { ok: false, value: '' }, // 서열코드
      '13': { ok: false, value: '' }, // EO번호
      '20': { ok: false, value: '' }, // 생산일자
      '21': { ok: false, value: '' }, // 부품4M
      '22': { ok: false, value: '' }, // A or @
      '23': { ok: false, value: '' }, // 추적번호
      '30': { ok: false, value: '' }, // 특이정보
      '31': { ok: false, value: '' }, // 초도품구분
      '40': { ok: false, value: '' }, // 업체영역
      '50': { ok: false, value: '' }  // Trailer
    };
    
    // Header 검증: "[)>06"
    if (raw.startsWith('[)>') && raw.includes('\x1E06')) {
      result['00'].ok = true;
      result['00'].value = '[)>' + String.fromCharCode(30) + '06';
    }
    
    // Trailer 검증: EOT 또는 #
    if (raw.endsWith('\x04') || raw.endsWith('#')) {
      result['50'].ok = true;
      result['50'].value = raw.endsWith('\x04') ? 'EOT' : '#';
    }
    
    // GS 구분자로 토큰 분리
    const tokens = raw.split('\x1D').map(token => token.trim()).filter(token => token.length > 0);
    
    // 각 토큰 분석
    tokens.forEach(token => {
      if (token.startsWith('V') && token.length === 5) {
        // 업체코드: V + 4자리
        result['10'].ok = true;
        result['10'].value = token.substring(1);
      } else if (token.startsWith('P') && token.length > 10 && token.length < 17 && !token.includes('-')) {
        // 부품번호: P + 10-16자리, 하이픈 없음
        result['11'].ok = true;
        result['11'].value = token.substring(1);
      } else if (token.startsWith('S') && token.length > 0 && token.length < 10) {
        // 서열코드: S + 1-9자리
        result['12'].ok = true;
        result['12'].value = token.substring(1);
      } else if (token.startsWith('E') && ((token.length > 8 && token.length < 11) || token.length === 1)) {
        // EO번호: E + 8-10자리 또는 E만
        result['13'].ok = true;
        result['13'].value = token.substring(1);
      } else if (token.startsWith('T')) {
        // 추적정보: T + 여러 필드
        const tContent = token.substring(1);
        
        // 생산일자 (6자리)
        if (tContent.length >= 6) {
          const dateStr = tContent.substring(0, 6);
          if (isValidDate(dateStr)) {
            result['20'].ok = true;
            result['20'].value = dateStr;
          }
        }
        
        // 부품4M (4자리)
        if (tContent.length >= 10) {
          const m4Str = tContent.substring(6, 10);
          result['21'].ok = true;
          result['21'].value = m4Str;
        }
        
        // A or @ (1자리)
        if (tContent.length >= 11) {
          const aChar = tContent.charAt(10);
          if (aChar === 'A' || aChar === '@') {
            result['22'].ok = true;
            result['22'].value = aChar;
          }
        }
        
        // 추적번호 (7자리 이상)
        if (tContent.length > 11) {
          const traceStr = tContent.substring(11);
          if (traceStr.length >= 7) {
            result['23'].ok = true;
            result['23'].value = traceStr;
          }
        }
      } else if (/^[1-9]/.test(token) && token.length > 1 && token.length < 42) {
        // 특이정보: 1-9로 시작, 2-41자리
        result['30'].ok = true;
        result['30'].value = token.substring(1);
      } else if (token.startsWith('M') && (token.length === 1 || (token.length === 2 && (token.charAt(1) === 'Y' || token.charAt(1) === 'N')))) {
        // 초도품구분: M 또는 MY/MN
        result['31'].ok = true;
        result['31'].value = token.length === 1 ? '' : token.charAt(1);
      } else if (token.startsWith('C') && token.length > 0 && token.length < 52) {
        // 업체영역: C + 1-51자리
        result['40'].ok = true;
        result['40'].value = token.substring(1);
      }
    });
    
    return result;
  }

  // 날짜 유효성 검사 (yymmdd)
  function isValidDate(dateStr) {
    if (!/^\d{6}$/.test(dateStr)) return false;
    
    const year = parseInt('20' + dateStr.substring(0, 2), 10);
    const month = parseInt(dateStr.substring(2, 4), 10);
    const day = parseInt(dateStr.substring(4, 6), 10);
    
    if (month < 1 || month > 12) return false;
    if (day < 1 || day > 31) return false;
    
    // 간단한 월별 일수 검증 (윤년은 고려하지 않음)
    const daysInMonth = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
    if (day > daysInMonth[month - 1]) return false;
    
    return true;
  }

  // 페이지 로드 시 초기화
  clearResults();
})();
</script>
</body>
</html>
