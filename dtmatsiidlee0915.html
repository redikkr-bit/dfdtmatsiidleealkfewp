<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DataMatrix 검증기</title>
<style>
  body {
    background-color: #f0f3f7;
    font-family: Arial, sans-serif;
    margin: 0;
    text-align: center;
  }
  h2 {
    color: #333;
    margin-top: 16px;
  }
  #video {
    width: 90%;
    max-width: 480px;
    border-radius: 12px;
    border: 3px solid #007bff;
    background-color: #000;
  }
  #result-box {
    margin-top: 16px;
    background: white;
    border-radius: 10px;
    padding: 16px;
    display: inline-block;
    text-align: left;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    width: 90%;
    max-width: 480px;
  }
  #result-text {
    font-size: 14px;
    color: #333;
    word-break: break-all;
  }
  #start-btn {
    margin-top: 20px;
    background-color: #007bff;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
  }
  #start-btn:hover {
    background-color: #0056b3;
  }
  .ok { color: #28a745; font-weight: bold; }
  .err { color: #d93025; font-weight: bold; }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 8px;
  }
  th, td {
    border-bottom: 1px solid #ddd;
    padding: 4px;
    text-align: left;
  }
  th { background: #f5f5f5; }
</style>
</head>
<body>

<h2>📦 DataMatrix 코드 검증기</h2>
<video id="video" playsinline autoplay></video>
<br>
<button id="start-btn">카메라 실행</button>

<div id="result-box">
  <h3>🔍 스캔 결과</h3>
  <div id="result-text">아직 인식된 코드가 없습니다.</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.18.6/umd/index.min.js"></script>

<script>
const video = document.getElementById('video');
const resultText = document.getElementById('result-text');
const startBtn = document.getElementById('start-btn');
let codeReader;

async function startCamera() {
  startBtn.disabled = true;
  startBtn.innerText = "카메라 준비 중...";

  try {
    codeReader = new ZXing.BrowserMultiFormatReader();
    const devices = await codeReader.listVideoInputDevices();
    if (devices.length === 0) {
      alert("카메라를 찾을 수 없습니다.");
      return;
    }
    const backCam = devices.find(d => /back|rear|후면/i.test(d.label)) || devices[0];
    await codeReader.decodeFromVideoDevice(backCam.deviceId, video, (result, err) => {
      if (result) handleResult(result.text);
    });

    startBtn.innerText = "스캔 중...";
    startBtn.style.background = "#28a745";
    startBtn.textContent = "카메라 작동 중";
  } catch (e) {
    console.error(e);
    alert("카메라 접근 오류: " + e.message);
    startBtn.disabled = false;
    startBtn.innerText = "카메라 다시 실행";
  }
}

function handleResult(data) {
  resultText.innerHTML = `<b>인식된 데이터:</b><br>${data.replace(/\r?\n/g, '<br>')}`;
  const parsed = parseDataMatrix(data);
  resultText.innerHTML += parsed.html;
}

function parseDataMatrix(raw) {
  let html = "<hr><b>세부 분석 결과</b><br>";
  const errors = [];

  // 기본 구문 체크
  if (!raw.includes("[)>") || !raw.includes("06") || !raw.includes("")) {
    html += `<div class="err">❌ 기본 구조 오류 ([)> ...  누락)</div>`;
    return { html };
  }

  // 구분자 단위로 나누기 ( = ASCII 29)
  const parts = raw.split("").filter(p => p.trim() !== "");

  const data = {
    header: parts[0] || "",
    model: parts.find(p => p.startsWith("V")) || "",
    part: parts.find(p => p.startsWith("P")) || "",
    line: parts.find(p => p.startsWith("S")) || "",
    trace: parts.find(p => p.startsWith("T")) || "",
    maker: parts.find(p => p.startsWith("C")) || "",
  };

  // 날짜 및 시리얼 분리
  let datePart = "", serialPart = "";
  if (data.trace && data.trace.length > 8) {
    const t = data.trace.substring(1); // 'T' 제거
    const y = "20" + t.substring(0, 2);
    const m = t.substring(2, 4);
    const d = t.substring(4, 6);
    datePart = `${y}-${m}-${d}`;
    serialPart = t.substring(6);
  }

  // 검증 규칙
  if (!/V[A-Z0-9]{2,}/.test(data.model)) errors.push("모델 코드 오류");
  if (!/^P\d{5,}/.test(data.part)) errors.push("부품 코드 형식 오류");
  if (!/^S[A-Z0-9]+/.test(data.line)) errors.push("라인 코드 형식 오류");
  if (!/^T\d{6}/.test(data.trace)) errors.push("트레이스 코드 형식 오류");
  if (!/^C[A-Z]+/.test(data.maker)) errors.push("업체 코드 형식 오류");

  const valid = errors.length === 0;

  html += `
  <table>
    <tr><th>항목</th><th>값</th></tr>
    <tr><td>모델</td><td>${data.model}</td></tr>
    <tr><td>부품코드</td><td>${data.part}</td></tr>
    <tr><td>라인코드</td><td>${data.line}</td></tr>
    <tr><td>날짜</td><td>${datePart}</td></tr>
    <tr><td>시리얼</td><td>${serialPart}</td></tr>
    <tr><td>업체</td><td>${data.maker}</td></tr>
  </table>`;

  html += valid
    ? `<div class="ok">✅ 형식 검증 통과</div>`
    : `<div class="err">❌ 오류 항목: ${errors.join(", ")}</div>`;

  return { html };
}

startBtn.addEventListener('click', startCamera);
</script>

</body>
</html>
