<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DataMatrix 검증기</title>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.18.6/umd/index.min.js"></script>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    text-align: center;
    margin: 0;
    padding: 0;
    background: #f7f7f7;
  }
  h2 {
    background: #004aad;
    color: white;
    padding: 10px;
    margin: 0;
  }
  video {
    width: 90%;
    max-width: 500px;
    margin-top: 10px;
    border-radius: 10px;
    border: 3px solid #004aad;
  }
  #result {
    margin-top: 20px;
    font-size: 1rem;
    white-space: pre-wrap;
    text-align: left;
    display: inline-block;
    background: white;
    border-radius: 8px;
    padding: 10px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
  }
  .ok { color: green; font-weight: bold; }
  .ng { color: red; font-weight: bold; }
</style>
</head>

<body>
<h2>📦 DataMatrix 코드 검증기</h2>
<video id="video" autoplay muted playsinline></video>
<div id="result">카메라가 준비되었습니다. 코드를 비춰주세요.</div>

<script>
const resultBox = document.getElementById('result');
const codeReader = new ZXing.BrowserMultiFormatReader();

async function startScanner() {
  try {
    const devices = await codeReader.listVideoInputDevices();
    // 후면 카메라 우선 선택
    const backCam = devices.find(d => /back|rear|후면|환경/i.test(d.label)) || devices[0];

    await codeReader.decodeFromVideoDevice(backCam.deviceId, 'video', (result, err) => {
      if (result) {
        handleCode(result.text);
      }
    });
  } catch (err) {
    console.error(err);
    resultBox.textContent = '❌ 카메라 접근 실패: ' + err;
  }
}

// ------------------------------
// 📏 검증 규칙 (참고: 업로드된 스크린샷 기반)
// ------------------------------
function validateCode(text) {
  const rules = [];

  // ANSI MH10.8.2 형태 파악 여부
  const hasHeader = text.startsWith("[)>");
  const hasTrailer = text.includes("");
  if (hasHeader && hasTrailer) {
    rules.push({ name: "형식 식별", ok: true, value: "ISO15434 구조 감지됨" });
  } else {
    rules.push({ name: "형식 식별", ok: false, value: "ISO15434 형식 아님" });
  }

  // T(날짜) 필드 확인
  const tMatch = text.match(/T(\d{6,8})/);
  if (tMatch) {
    rules.push({ name: "날짜 코드(T)", ok: true, value: tMatch[1] });
  } else {
    rules.push({ name: "날짜 코드(T)", ok: false, value: "누락됨" });
  }

  // DWA, DRM 등 시리얼 코드 확인
  const serialMatch = text.match(/DWA\d+|DRM\d+|A\d{5,}/);
  if (serialMatch) {
    rules.push({ name: "시리얼코드", ok: true, value: serialMatch[0] });
  } else {
    rules.push({ name: "시리얼코드", ok: false, value: "없음" });
  }

  // P(품번) 필드 확인
  const pMatch = text.match(/P\d{5,}/g);
  if (pMatch) {
    rules.push({ name: "품번(P)", ok: true, value: pMatch.join(', ') });
  } else {
    rules.push({ name: "품번(P)", ok: false, value: "없음" });
  }

  // S(서열코드)
  const sMatch = text.match(/S[A-Z0-9]+/);
  if (sMatch) {
    rules.push({ name: "서열코드(S)", ok: true, value: sMatch[0] });
  } else {
    rules.push({ name: "서열코드(S)", ok: false, value: "없음" });
  }

  return rules;
}

// ------------------------------
// 결과 표시
// ------------------------------
function handleCode(text) {
  const rules = validateCode(text);
  let html = `<div style="font-size:0.9rem;"><b>인식된 코드:</b><br>${text}</div><hr>`;
  rules.forEach(r => {
    html += `<div>${r.ok ? "✅" : "❌"} <b>${r.name}</b> → <span class="${r.ok ? 'ok' : 'ng'}">${r.value}</span></div>`;
  });
  resultBox.innerHTML = html;
}

// 실행
startScanner();
</script>
</body>
</html>
